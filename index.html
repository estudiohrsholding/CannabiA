<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'emerald-500': '#10b981',
                        'emerald-600': '#059669',
                        'slate-700': '#334155',
                        'slate-800': '#1e293b',
                        'slate-900': '#0f172a',
                    }
                }
            }
        }
    </script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <!-- qrcode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Estilos para la App */
        body {
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* slate-50 */
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        /* Animaciones de Modales */
        .modal-overlay {
            opacity: 0;
            transition: opacity 0.2s ease-out;
            pointer-events: none;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .modal-content.open {
            transform: scale(1);
            opacity: 1;
        }
        /* Animación de pulso para botón TPV */
        @keyframes pulse-emerald {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            50% {
                box-shadow: 0 0 0 0.5rem rgba(16, 185, 129, 0);
            }
        }
        .animate-pulse-emerald {
            animation: pulse-emerald 2s infinite;
        }
        /* Estilos para dropdown (kebab menu) */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #1e293b; /* slate-800 */
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #334155; /* border-slate-700 */
        }
        .dropdown-content a {
            color: #f8fafc; /* slate-50 */
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
        }
        .dropdown-content a:hover {
            background-color: #334155; /* slate-700 */
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-50 font-sans min-h-screen flex flex-col items-center justify-center p-4">

        <!-- Vista de Login -->
        <div id="login-view" class="view active min-h-screen flex items-center justify-center">
            <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-sm">
                <h2 class="text-3xl font-bold text-center text-emerald-500 mb-6">Acceso al Club</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                        <input type="email" id="email" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500 transition-colors duration-200" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-slate-300 mb-2">Contraseña</label>
                        <input type="password" id="password" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500 transition-colors duration-200" required>
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
                        Entrar
                    </button>
                </form>
            </div>
        </div>

        <main>
            <section id="main-menu-view" class="view">
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 text-center">
                <div data-view="socios" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <h2 class="text-xl font-semibold">Socios</h2>
                    </div>
                    <div data-view="articulos-section" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        <h2 class="text-xl font-semibold">Artículos</h2>
                    </div>
                    <div data-view="tpv-section" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        <h2 class="text-xl font-semibold">TPV</h2>
                    </div>
                    <div data-view="stats-view" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <h2 class="text-xl font-semibold">Estadísticas</h2>
                    </div>
                    <div data-view="historial-section" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h2 class="text-xl font-semibold">Historial</h2>
                    </div>
                </div>
            </div>

            <!-- Vista de Socios -->
            <section id="socios-section" class="view">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Socios</h2>
                    <button id="show-add-socio-modal" class="bg-blue-600 text-white hover:bg-blue-700 py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Añadir Socio
                    </button>
                </div>
                <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">Nombre</th>
                                <th scope="col" class="py-3 px-6">Apellido</th>
                                <th scope="col" class="py-3 px-6">Estado</th>
                                <th scope="col" class="py-3 px-6">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="socios-list">
                            <!-- Los socios se renderizarán aquí -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="articulos-section" class="view hidden space-y-8">
                <div>
                    <h2 class="text-2xl font-bold mb-4">Añadir Nuevo Artículo</h2>
                    <form id="form-articulo" class="bg-gray-800 p-6 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="article-nombre" class="block mb-2 text-sm font-medium text-gray-300">Nombre</label>
                                <input type="text" id="article-nombre" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            </div>
                            <div>
                                <label for="article-categoria" class="block mb-2 text-sm font-medium text-gray-300">Categoría</label>
                                <input list="categorias-datalist" type="text" id="article-categoria" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                <datalist id="categorias-datalist"></datalist>
                            </div>
                            <div>
                                <label for="article-unidad" class="block mb-2 text-sm font-medium text-gray-300">Unidad Mínima de Dispensa</label>
                                <input type="number" id="article-unidad" min="1" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            </div>
                            <div>
                                <label for="article-precio" class="block mb-2 text-sm font-medium text-gray-300">Precio por Unidad (€)</label>
                                <input type="number" id="article-precio" min="0" step="0.01" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            </div>
                        </div>
                        <div class="mt-6 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Añadir Artículo</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h2 class="text-2xl font-bold mb-4">Inventario</h2>
                    <div id="lista-articulos-container" class="space-y-6">
                        <!-- Los artículos se renderizarán aquí -->
                    </div>
                    <button id="add-socio-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Añadir Socio</button>
                </div>
                <!-- Skeleton Loader para Socios -->
                <div id="socios-skeleton-loader" class="space-y-4">
                    <div class="bg-slate-800 p-4 rounded-lg animate-pulse h-16"></div>
                    <div class="bg-slate-800 p-4 rounded-lg animate-pulse h-16"></div>
                    <div class="bg-slate-800 p-4 rounded-lg animate-pulse h-16"></div>
                </div>
                <!-- Empty State para Socios -->
                <div id="socios-empty-state" class="hidden text-center py-16">
                    <svg class="w-24 h-24 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.125-1.273-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.125-1.273.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <h3 class="text-xl font-semibold text-slate-400">Aún no tienes socios registrados</h3>
                    <p class="text-slate-500 mb-6">Empieza a construir tu comunidad.</p>
                    <button id="add-first-socio-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-md transition-colors duration-200">Añadir tu primer socio</button>
                </div>
                <div id="socios-list" class="space-y-3">
                    <!-- Las tarjetas de socios se insertarán aquí -->
                </div>
            </section>

            <!-- Vista de Artículos -->
            <section id="articulos-section" class="view">
                 <div class="flex justify-between items-center mb-4">
                    <button class="back-to-menu bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">← Volver al Menú</button>
                    <div class="relative w-1/3">
                        <input type="text" id="search-articulo" placeholder="Buscar artículo..." class="w-full p-2 pl-10 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500">
                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <button id="add-articulo-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Añadir Artículo</button>
                </div>
                <!-- Skeleton Loader para Artículos -->
                <div id="articulos-skeleton-loader" class="space-y-4">
                    <div class="bg-slate-800 p-4 rounded-lg animate-pulse h-24"></div>
                    <div class="bg-slate-800 p-4 rounded-lg animate-pulse h-24"></div>
                </div>
                 <!-- Empty State para Artículos -->
                 <div id="articulos-empty-state" class="hidden text-center py-16">
                    <svg class="w-24 h-24 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <h3 class="text-xl font-semibold text-slate-400">Tu inventario está vacío</h3>
                    <p class="text-slate-500 mb-6">Añade artículos para empezar a vender.</p>
                    <button id="add-first-articulo-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-md transition-colors duration-200">Añadir tu primer artículo</button>
                </div>
                <div id="articulos-list" class="space-y-6">
                    <!-- Las categorías y artículos se insertarán aquí -->
                </div>
            </section>

            <!-- Vista de Historial -->
            <section id="historial-section" class="view">
                <div class="flex justify-between items-center mb-4">
                    <button class="back-to-menu bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">← Volver al Menú</button>
                    <h2 class="text-2xl font-bold">Actividad Reciente</h2>
                </div>
                <div id="historial-list" class="space-y-3">
                     <!-- El historial se insertará aquí -->
                </div>
            </section>

            <!-- Vista de TPV -->
            <section id="tpv-section" class="view">
                <button class="back-to-menu bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md mb-4 transition-colors duration-200">← Volver al Menú</button>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Columna del formulario -->
                    <div class="md:col-span-2 bg-slate-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Nueva Dispensa</h2>
                        <form id="tpv-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="tpv-socio" class="block text-sm font-medium text-slate-300 mb-2">Socio</label>
                                    <select id="tpv-socio" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500 transition-colors duration-200" required>
                                        <option value="">Selecciona un socio...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tpv-articulo" class="block text-sm font-medium text-slate-300 mb-2">Artículo</label>
                                    <select id="tpv-articulo" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500 transition-colors duration-200" required>
                                        <option value="">Selecciona un artículo...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label for="tpv-cantidad" class="block text-sm font-medium text-slate-300 mb-2">Cantidad</label>
                                    <input type="number" id="tpv-cantidad" min="0" step="0.1" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500 transition-colors duration-200" required>
                                </div>
                                <div>
                                    <label for="tpv-metodo-pago" class="block text-sm font-medium text-slate-300 mb-2">Método de Pago</label>
                                    <select id="tpv-metodo-pago" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500 transition-colors duration-200" required>
                                        <option value="puntos">Puntos</option>
                                        <option value="efectivo">Efectivo</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- Columna del resumen -->
                    <div id="resumen-tpv" class="bg-slate-800 p-6 rounded-lg shadow-lg border-l-4 border-emerald-600">
                        <h3 class="text-xl font-bold mb-4">Resumen de Dispensa</h3>
                        <div class="space-y-3 text-lg">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Precio Unitario:</span>
                                <span id="resumen-precio-unitario" class="font-semibold">0.00 €</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Cantidad:</span>
                                <span id="resumen-cantidad" class="font-semibold">0</span>
                            </div>
                            <hr class="border-slate-700 my-3">
                            <div class="flex justify-between text-2xl">
                                <span class="font-bold">Total:</span>
                                <span id="resumen-total" class="font-bold text-emerald-400">0.00 €</span>
                            </div>
                        </div>
                        <button id="realizar-dispensa-button" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-md transition-all duration-200 disabled:bg-slate-600 disabled:cursor-not-allowed disabled:opacity-50" disabled>
                             <span class="spinner hidden w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin"></span>
                             <span class="button-text">Realizar Dispensa</span>
                        </button>
                    </div>
                </div>
            </section>
            <section id="stats-view" class="view hidden">
                <h2 class="text-2xl font-bold mb-4">Estadísticas de Dispensas (Últimos 7 días)</h2>
                <div class="bg-gray-800 p-6 rounded-lg">
                    <canvas id="grafico-ventas-semanal"></canvas>
                </div>
            </section>
            
            <section id="historial-section" class="view hidden">
                 <h2 class="text-2xl font-bold mb-4">Historial de Operaciones</h2>
                 <div id="historial-container" class="space-y-4">
                     <!-- El historial de eventos se renderizará aquí -->
                 </div>
            </section>
        </main>
    </div>
    
    <!-- Modales -->

    <!-- Modal para Añadir/Editar Socio -->
    <div id="socio-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="modal-content bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h2 id="socio-modal-title" class="text-2xl font-bold mb-6 text-emerald-500">Añadir Nuevo Socio</h2>
            <form id="socio-form">
                <input type="hidden" id="socio-id-hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="socio-nombre" class="block text-sm font-medium text-slate-300 mb-2">Nombre Completo</label>
                        <input type="text" id="socio-nombre" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="socio-id" class="block text-sm font-medium text-slate-300 mb-2">ID de Socio</label>
                        <input type="text" id="socio-id" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="socio-foto" class="block text-sm font-medium text-slate-300 mb-2">Foto de Perfil (URL o subir)</label>
                    <input type="file" id="socio-foto-upload" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                    <input type="text" id="socio-foto-url" placeholder="O pega una URL de imagen aquí" class="w-full mt-2 p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500">
                </div>
                 <div class="mb-4">
                    <label for="socio-puntos" class="block text-sm font-medium text-slate-300 mb-2">Puntos Iniciales</label>
                    <input type="number" id="socio-puntos" value="0" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500" required>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-socio-modal" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Cancelar</button>
                    <button type="submit" id="save-socio-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center min-w-[120px]">
                        <span class="spinner hidden w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin"></span>
                        <span class="button-text">Guardar Socio</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Añadir/Editar Artículo -->
    <div id="articulo-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="modal-content bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h2 id="articulo-modal-title" class="text-2xl font-bold mb-6 text-emerald-500">Añadir Nuevo Artículo</h2>
            <form id="articulo-form">
                <input type="hidden" id="articulo-editing-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="articulo-nombre" class="block text-sm font-medium text-slate-300 mb-2">Nombre</label>
                        <input type="text" id="articulo-nombre" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="articulo-categoria" class="block text-sm font-medium text-slate-300 mb-2">Categoría</label>
                        <input type="text" id="articulo-categoria" list="categorias-datalist" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500" required>
                        <datalist id="categorias-datalist"></datalist>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="articulo-precio" class="block text-sm font-medium text-slate-300 mb-2">Precio (€)</label>
                        <input type="number" id="articulo-precio" step="0.01" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="articulo-stock" class="block text-sm font-medium text-slate-300 mb-2">Stock (unidades)</label>
                        <input type="number" id="articulo-stock" step="0.1" class="w-full p-3 rounded-md bg-slate-700 border border-slate-600 focus:border-emerald-500 focus:ring-emerald-500" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-articulo-modal" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Cancelar</button>
                    <button type="submit" id="save-articulo-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center justify-center min-w-[140px]">
                        <span class="spinner hidden w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin"></span>
                        <span class="button-text">Guardar Artículo</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalles del Socio -->
    <div id="socio-details-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="modal-content bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-emerald-500">Carnet Digital</h2>
            <div class="bg-gradient-to-br from-slate-700 to-slate-600 p-6 rounded-lg">
                <div class="flex items-center space-x-6">
                    <img id="details-socio-foto" src="https://via.placeholder.com/100" alt="Foto de socio" class="w-24 h-24 rounded-full border-4 border-emerald-500 object-cover">
                    <div>
                        <p class="text-2xl font-bold" id="details-socio-nombre">Nombre del Socio</p>
                        <p class="text-slate-300">ID: <span id="details-socio-id">00000</span></p>
                        <p class="text-sm text-slate-400">Caduca: <span id="details-socio-caducidad">DD/MM/AAAA</span></p>
                    </div>
                </div>
                <div id="qrcode" class="mt-6 p-4 bg-white rounded-lg flex justify-center"></div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-details-modal" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================================================================
        // 🔥 ¡ATENCIÓN! REEMPLAZA ESTE OBJETO CON TU CONFIGURACIÓN REAL DE FIREBASE
        // Tu configuración la encuentras en: Consola de Firebase > Configuración del proyecto (⚙️)
        // ==========================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCCIRk9Vip1J5Zc8xAeObsU6poc-J8lcj0",
            authDomain: "cannabia-9dfe3.firebaseapp.com",
            projectId: "cannabia-9dfe3",
            storageBucket: "cannabia-9dfe3.firebasestorage.app",
            messagingSenderId: "605207982385",
            appId: "1:605207982385:web:58254637495b2b6d2bc010",
            measurementId: "G-6M1WRYG1PS"
        };

        // --- Verificación de Configuración ---
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIza...")) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'fixed top-0 left-0 w-full p-4 bg-red-800 text-white text-center text-lg z-50';
            warningDiv.textContent = "¡ERROR DE CONFIGURACIÓN! Reemplaza el objeto 'firebaseConfig' de ejemplo en index.html con el tuyo.";
            document.body.prepend(warningDiv);
            // Detenemos la ejecución para prevenir errores más complejos
            throw new Error("Configuración de Firebase no válida o ausente.");
        }

        // Inicializa Firebase
        const { initializeApp } = firebase;
        const { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signInWithEmailAndPassword, signOut } = firebase.auth;
        const { getFirestore, collection, query, orderBy, onSnapshot, where, getDocs } = firebase.firestore;
        const { getStorage } = firebase.storage;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentUser = null;

        // --- GESTIÓN DE VISTAS (BLOQUE CORREGIDO) ---
        const views = document.querySelectorAll('.view');
        const menuItems = document.querySelectorAll('.menu-item');
        const viewTitle = document.getElementById('view-title');
        const backToMenuBtn = document.getElementById('back-to-menu');
        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');

        function showView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.remove('hidden');
                
                const isMenuView = viewId === 'main-menu-view';
                if (backToMenuBtn) backToMenuBtn.classList.toggle('hidden', isMenuView);
                
                if (viewTitle) {
                    if (isMenuView) {
                        viewTitle.textContent = 'Menú Principal';
                    } else {
                        viewTitle.textContent = activeView.querySelector('h2').textContent;
                    }
                }

                // Si la vista es la de estadísticas, renderizar el gráfico
                if (viewId === 'stats-view') {
                    // renderizarGraficoDispensas();
                }
            }
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const viewId = item.dataset.view;
                showView(viewId);
            });
        });

        if(backToMenuBtn) backToMenuBtn.addEventListener('click', () => showView('main-menu-view'));

        // --- LÓGICA DE AUTENTICACIÓN ---
        setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, user => {
            if(loadingView) loadingView.classList.add('hidden');
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                showView('main-menu-view');
                // listenToSocios();
                // listenToHistory();
                // listenToArticles();
                // listenToSociosForTPV();
                // listenToArticlesForTPV();
            } else {
                currentUser = null;
                appContainer.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            if(loginError) loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if(loginError) loginError.textContent = 'Credenciales incorrectas.';
                console.error("Login Error:", error);
            }
        });

        if(logoutButton) logoutButton.addEventListener('click', () => signOut(auth));
        
        // --- MÓDULO DE SOCIOS ---
        const sociosList = document.getElementById('socios-list');
        const addSocioModalOverlay = document.getElementById('add-socio-modal-overlay');
        const addSocioForm = document.getElementById('add-socio-form');
        const socioIdPhotoInput = document.getElementById('socio-id-photo');
        const closeAddSocioModalBtn = document.getElementById('close-add-socio-modal');
        const cancelAddSocioBtn = document.getElementById('cancel-add-socio');
        const socioDetailsModalOverlay = document.getElementById('socio-details-modal-overlay');
        const socioDetailsModalTitle = document.getElementById('socio-details-modal-title');
        const socioDetailsContent = document.getElementById('socio-details-content');
        const closeSocioDetailsModalBtn = document.getElementById('close-socio-details-modal');

        async function showPartnerDetails(socioId, socioNombre) {
            socioDetailsModalTitle.textContent = `Historial de ${socioNombre}`;
            socioDetailsModalOverlay.classList.remove('hidden');
            socioDetailsContent.innerHTML = '<p class="text-center p-8">Cargando historial...</p>';

            try {
                const dispensasRef = collection(db, "dispensas");
                const q = query(dispensasRef, where("idSocio", "==", socioId), orderBy("fecha", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    socioDetailsContent.innerHTML = '<p class="text-center p-8 text-gray-400">Este socio no tiene dispensas registradas.</p>';
                    return;
                }

                let html = '<div class="space-y-3">';
                querySnapshot.forEach(doc => {
                    const dispensa = doc.data();
                    const fecha = formatFirebaseTimestamp(dispensa.fecha); // Suponiendo que tienes esta función
                    html += `
                        <div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${dispensa.nombreArticulo}</p>
                                <p class="text-sm text-gray-400">${fecha}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-400">${dispensa.precioTotal.toFixed(2)} €</p>
                                <p class="text-sm text-gray-300">Cantidad: ${dispensa.cantidad}</p>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                socioDetailsContent.innerHTML = html;

            } catch (error) {
                console.error("Error al obtener el historial del socio:", error);
                socioDetailsContent.innerHTML = '<p class="text-center p-8 text-red-500">No se pudo cargar el historial. Inténtalo de nuevo.</p>';
                // showToast("Error al cargar el historial.", true); // Suponiendo que tienes esta función
            }
        }

        function closeSocioDetailsModal() {
            socioDetailsModalOverlay.classList.add('hidden');
            socioDetailsContent.innerHTML = '<p class="text-center p-8">Cargando historial...</p>'; // Reset content
        }
        
        if (closeSocioDetailsModalBtn) closeSocioDetailsModalBtn.addEventListener('click', closeSocioDetailsModal);
        if (socioDetailsModalOverlay) {
            socioDetailsModalOverlay.addEventListener('click', (e) => {
                if (e.target === socioDetailsModalOverlay) {
                    closeSocioDetailsModal();
                }
            });
        }


        function getSociosCollectionRef() {
            if (!currentUser || !firebaseConfig.appId) {
                console.error("User not logged in or appId not configured");
                return null;
            }
            return collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/socios`);
        }

        function optimizeImage(file, maxSize = 1024, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function listenToSocios() {
            const sociosCollectionRef = getSociosCollectionRef();
            if (!sociosCollectionRef) return;

            const q = query(sociosCollectionRef, orderBy("apellido", "asc"));
            onSnapshot(q, (snapshot) => {
                sociosList.innerHTML = '';
                if (snapshot.empty) {
                    sociosList.innerHTML = '<tr><td colspan="4" class="py-4 px-6 text-center text-gray-500">No hay socios registrados.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const socio = doc.data();
                    const hoy = new Date();
                    let estadoFinal = socio.estado;
                    let filaClass = '';

                    if (socio.estado === 'Verde' && socio.fecha_caducidad_pago && socio.fecha_caducidad_pago.toDate() < hoy) {
                        estadoFinal = 'Gris';
                        filaClass = 'bg-yellow-900'; // Highlight expired
                    }

                    const statusInfo = {
                        'Gris': { color: 'bg-gray-500', text: 'Pendiente' },
                        'Rojo': { color: 'bg-red-500', text: 'Non Grata' },
                        'Verde': { color: 'bg-green-500', text: 'Pagado' }
                    };
                    const currentStatus = statusInfo[estadoFinal];

                    const socioElement = `
                        <tr class="${filaClass} border-b border-gray-700">
                            <td class="py-4 px-6">${socio.nombre}</td>
                            <td class="py-4 px-6">${socio.apellido}</td>
                            <td class="py-4 px-6">
                                <span class="px-2 py-1 font-semibold leading-tight text-white rounded-full ${currentStatus.color}">
                                    ${currentStatus.text}
                                </span>
                            </td>
                            <td class="py-4 px-6">
                                <button data-id="${doc.id}" data-estado="${socio.estado}" class="change-status-btn text-blue-400 hover:underline">Cambiar Estado</button>
                                <button data-id="${doc.id}" data-nombre="${socio.nombre} ${socio.apellido}" data-url="${socio.url_foto_id}" class="view-details-btn text-blue-400 hover:underline ml-4">Ver Detalles</button>
                            </td>
                        </tr>
                    `;
                    sociosList.innerHTML += socioElement;
                });
            });
        }

        if (addSocioForm) {
            addSocioForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Validación
                const nombre = document.getElementById('socio-nombre').value.trim();
                const apellido = document.getElementById('socio-apellido').value.trim(); // Suponiendo que tienes un campo apellido
                const file = socioIdPhotoInput.files[0];
                let isValid = true;

                // Limpiar errores previos
                // document.getElementById('error-nombre').textContent = '';
                // document.getElementById('error-apellido').textContent = '';
                // document.getElementById('error-foto').textContent = '';
                // document.getElementById('form-error').classList.add('hidden');

                if (!nombre) {
                    // document.getElementById('error-nombre').textContent = 'El nombre es obligatorio.';
                    isValid = false;
                }
                if (!apellido) {
                    // document.getElementById('error-apellido').textContent = 'El apellido es obligatorio.';
                    isValid = false;
                }
                if (!file) {
                    // document.getElementById('error-foto').textContent = 'La foto del DNI es obligatoria.';
                    isValid = false;
                }

                if (!isValid) return;

                const submitBtn = document.getElementById('submit-socio-btn');
                const btnText = submitBtn.querySelector('.btn-text');
                const spinner = submitBtn.querySelector('.spinner');

                // --- Feedback de envío ---
                submitBtn.disabled = true;
                btnText.textContent = 'Guardando...';
                spinner.classList.remove('hidden');
            });
        }
    </script>
</body>
</html>