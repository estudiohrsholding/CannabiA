<!DOCTYPE html>
<html lang="es" class="bg-gray-900 text-white">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor del Club v2</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .view { transition: opacity 0.3s ease-in-out; }
    </style>
</head>

<body class="min-h-screen p-4 bg-gray-900">

    <div id="loading-view" class="flex items-center justify-center h-screen">
        <p class="text-xl">Cargando aplicación...</p>
    </div>

    <div id="login-view" class="hidden w-full max-w-sm mx-auto mt-20">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">Iniciar Sesión</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block mb-2 text-sm font-medium text-gray-300">Email</label>
                    <input type="email" id="login-email" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block mb-2 text-sm font-medium text-gray-300">Contraseña</label>
                    <input type="password" id="login-password" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Entrar</button>
                <p id="login-error" class="text-red-500 text-center mt-4"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden w-full max-w-6xl mx-auto">
        <div id="view-id-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Foto del ID</h2>
                <img id="id-photo-container" src="" alt="Foto del ID" class="rounded-lg max-h-96 mx-auto"/>
                <div class="flex justify-end mt-4">
                    <button type="button" id="close-view-id-modal" class="bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded">Cerrar</button>
                </div>
            </div>
        </div>
        <header class="flex justify-between items-center mb-6">
            <h1 id="view-title" class="text-3xl font-bold">Menú Principal</h1>
            <div>
                <button id="back-to-menu" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-4">← Volver</button>
                <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
            </div>
        </header>

        <main>
            <section id="main-menu-view" class="view">
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 text-center">
                <div data-view="socios" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <h2 class="text-xl font-semibold">Socios</h2>
                    </div>
                    <div data-view="articles-view" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        <h2 class="text-xl font-semibold">Artículos</h2>
                    </div>
                    <div data-view="tpv-view" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        <h2 class="text-xl font-semibold">TPV</h2>
                    </div>
                    <div data-view="stats-view" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <h2 class="text-xl font-semibold">Estadísticas</h2>
                    </div>
                    <div data-view="history-view" class="menu-item bg-gray-800 p-6 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h2 class="text-xl font-semibold">Historial</h2>
                    </div>
                </div>
            </section>

            <section id="socios" class="view hidden">
                <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">Nombre</th>
                                <th scope="col" class="py-3 px-6">Apellido</th>
                                <th scope="col" class="py-3 px-6">Estado</th>
                                <th scope="col" class="py-3 px-6">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="socios-list">
                            <!-- Los socios se renderizarán aquí -->
                        </tbody>
                    </table>
                </div>
                <button id="show-add-socio-modal" class="fixed bottom-10 right-10 bg-blue-600 hover:bg-blue-700 text-white font-bold w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl">
                    +
                </button>
            </section>
            
            <section id="articles-view" class="view hidden space-y-8">
                <div>
                    <h2 class="text-2xl font-bold mb-4">Añadir Nuevo Artículo</h2>
                    <form id="add-article-form" class="bg-gray-800 p-6 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="article-nombre" class="block mb-2 text-sm font-medium text-gray-300">Nombre del Artículo</label>
                                <input type="text" id="article-nombre" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            </div>
                            <div>
                                <label for="article-categoria" class="block mb-2 text-sm font-medium text-gray-300">Categoría</label>
                                <input type="text" id="article-categoria" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            </div>
                            <div>
                                <label for="article-unidad" class="block mb-2 text-sm font-medium text-gray-300">Unidad Mínima de Venta</label>
                                <input type="number" id="article-unidad" min="1" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            </div>
                            <div>
                                <label for="article-precio" class="block mb-2 text-sm font-medium text-gray-300">Precio por Unidad (€)</label>
                                <input type="number" id="article-precio" min="0.01" step="0.01" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            </div>
                        </div>
                        <div class="mt-6 text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Añadir Artículo</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h2 class="text-2xl font-bold mb-4">Inventario</h2>
                    <div id="articles-list" class="space-y-6">
                        <!-- Los artículos se renderizarán aquí -->
                    </div>
                </div>
            </section>
            <section id="tpv-view" class="view hidden"><h2 class="text-2xl font-bold mb-4">Terminal Punto de Venta (TPV)</h2><p class="text-gray-400">Próximamente...</p></section>
            <section id="stats-view" class="view hidden"><h2 class="text-2xl font-bold mb-4">Estadísticas</h2><p class="text-gray-400">Próximamente...</p></section>
            
            <section id="history-view" class="view hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Historial de Cambios</h2>
                </div>
                <div id="logs-list" class="space-y-2 text-sm">
                    </div>
            </section>
        </main>
    </div>
    
    <div id="add-socio-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Añadir Socio</h2>
            <form id="add-socio-form">
                <div class="mb-4">
                    <label for="socio-nombre" class="block mb-2 text-sm font-medium text-gray-300">Nombre</label>
                    <input type="text" id="socio-nombre" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mb-4">
                    <label for="socio-apellido" class="block mb-2 text-sm font-medium text-gray-300">Apellido</label>
                    <input type="text" id="socio-apellido" class="bg-gray-700 border border-gray-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mb-4">
                    <label for="socio-id-photo" class="block mb-2 text-sm font-medium text-gray-300">Foto del ID</label>
                    <input type="file" id="socio-id-photo" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-add-socio" class="bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded">Guardar</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Importa las funciones que necesitas de los SDKs de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, query, orderBy, setDoc, increment } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // ==========================================================================================
        // 🔥 ¡ATENCIÓN! REEMPLAZA ESTE OBJETO CON TU CONFIGURACIÓN REAL DE FIREBASE
        // Tu configuración la encuentras en: Consola de Firebase > Configuración del proyecto (⚙️)
        // ==========================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCCIRk9Vip1J5Zc8xAeObsU6poc-J8lcj0",
            authDomain: "cannabia-9dfe3.firebaseapp.com",
            projectId: "cannabia-9dfe3",
            storageBucket: "cannabia-9dfe3.firebasestorage.app",
            messagingSenderId: "605207982385",
            appId: "1:605207982385:web:58254637495b2b6d2bc010",
            measurementId: "G-6M1WRYG1PS"
        };

        // --- Verificación de Configuración ---
        // Esta comprobación te alertará si olvidas reemplazar la configuración de ejemplo.
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIza...")) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'fixed top-0 left-0 w-full p-4 bg-red-800 text-white text-center text-lg z-50';
            warningDiv.textContent = "¡ERROR DE CONFIGURACIÓN! Reemplaza el objeto 'firebaseConfig' de ejemplo en index.html con el tuyo.";
            document.body.prepend(warningDiv);
            // Detenemos la ejecución para prevenir errores más complejos
            throw new Error("Configuración de Firebase no válida o ausente.");
        }

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentUser = null;

        // --- GESTIÓN DE VISTAS (BLOQUE CORREGIDO) ---
        const views = document.querySelectorAll('.view');
        const menuItems = document.querySelectorAll('.menu-item');
        const viewTitle = document.getElementById('view-title');
        const backToMenuBtn = document.getElementById('back-to-menu');
        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');

        function showView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.remove('hidden');
                
                const isMenuView = viewId === 'main-menu-view';
                backToMenuBtn.classList.toggle('hidden', isMenuView);
                
                if (isMenuView) {
                    viewTitle.textContent = 'Menú Principal';
                } else {
                    viewTitle.textContent = activeView.querySelector('h2').textContent;
                }
            }
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const viewId = item.dataset.view;
                showView(viewId);
            });
        });

        backToMenuBtn.addEventListener('click', () => showView('main-menu-view'));

        // --- LÓGICA DE AUTENTICACIÓN ---
        setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, user => {
            loadingView.classList.add('hidden');
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                showView('main-menu-view');
                listenToSocios();
                listenToLogs();
                listenToArticles();
            } else {
                currentUser = null;
                appContainer.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = 'Credenciales incorrectas.';
                console.error("Login Error:", error);
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));
        
        // --- MÓDULO DE SOCIOS ---
        const sociosList = document.getElementById('socios-list');
        const addSocioModal = document.getElementById('add-socio-modal');
        const addSocioForm = document.getElementById('add-socio-form');
        const socioIdPhotoInput = document.getElementById('socio-id-photo');

        function getSociosCollectionRef() {
            if (!currentUser || !firebaseConfig.appId) {
                console.error("User not logged in or appId not configured");
                return null;
            }
            return collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/socios`);
        }

        function optimizeImage(file, maxSize = 1024, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function listenToSocios() {
            const sociosCollectionRef = getSociosCollectionRef();
            if (!sociosCollectionRef) return;

            const q = query(sociosCollectionRef, orderBy("apellido", "asc"));
            onSnapshot(q, (snapshot) => {
                sociosList.innerHTML = '';
                if (snapshot.empty) {
                    sociosList.innerHTML = '<tr><td colspan="4" class="py-4 px-6 text-center text-gray-500">No hay socios registrados.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const socio = doc.data();
                    const hoy = new Date();
                    let estadoFinal = socio.estado;
                    let filaClass = '';

                    if (socio.estado === 'Verde' && socio.fecha_caducidad_pago && socio.fecha_caducidad_pago.toDate() < hoy) {
                        estadoFinal = 'Gris';
                        filaClass = 'bg-yellow-900'; // Highlight expired
                    }

                    const statusInfo = {
                        'Gris': { color: 'bg-gray-500', text: 'Pendiente' },
                        'Rojo': { color: 'bg-red-500', text: 'Non Grata' },
                        'Verde': { color: 'bg-green-500', text: 'Pagado' }
                    };
                    const currentStatus = statusInfo[estadoFinal];

                    const socioElement = `
                        <tr class="${filaClass} border-b border-gray-700">
                            <td class="py-4 px-6">${socio.nombre}</td>
                            <td class="py-4 px-6">${socio.apellido}</td>
                            <td class="py-4 px-6">
                                <span class="px-2 py-1 font-semibold leading-tight text-white rounded-full ${currentStatus.color}">
                                    ${currentStatus.text}
                                </span>
                            </td>
                            <td class="py-4 px-6">
                                <button data-id="${doc.id}" data-estado="${socio.estado}" class="change-status-btn text-blue-400 hover:underline">Cambiar Estado</button>
                                <button data-id="${doc.id}" data-url="${socio.url_foto_id}" class="view-id-btn text-blue-400 hover:underline ml-4" ${!socio.url_foto_id ? 'disabled' : ''}>Ver ID</button>
                            </td>
                        </tr>
                    `;
                    sociosList.innerHTML += socioElement;
                });
            });
        }

        addSocioForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('socio-nombre').value;
            const apellido = document.getElementById('socio-apellido').value;
            const file = socioIdPhotoInput.files[0];

            const sociosCollectionRef = getSociosCollectionRef();
            if (!sociosCollectionRef) return;

            // Step 1: Create the document in Firestore to get an ID
            const newSocioRef = doc(sociosCollectionRef);

            const newSocioData = {
                nombre,
                apellido,
                estado: 'Gris',
                fecha_ingreso: serverTimestamp(),
                fecha_caducidad_pago: null,
                url_foto_id: '' // Initialize with empty string
            };

            // Set the initial data
            await setDoc(newSocioRef, newSocioData);

            // Step 2: If there's a file, optimize and upload it
            if (file) {
                const optimizedBlob = await optimizeImage(file);
                const storageRef = ref(storage, `socios_ids/${newSocioRef.id}.jpg`);
                await uploadBytes(storageRef, optimizedBlob);

                // Step 3: Get the download URL
                const downloadURL = await getDownloadURL(storageRef);

                // Step 4: Update the document with the URL
                await updateDoc(newSocioRef, {
                    url_foto_id: downloadURL
                });
            }

            addSocioForm.reset();
            addSocioModal.classList.add('hidden');
        });

        sociosList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('change-status-btn')) {
                const socioId = e.target.dataset.id;
                let currentEstado = e.target.dataset.estado;
                let newEstado;
                let fechaCaducidad = null;

                if (currentEstado === 'Gris') {
                    newEstado = 'Verde';
                    const futureDate = new Date();
                    futureDate.setDate(futureDate.getDate() + 365);
                    fechaCaducidad = futureDate;
                } else if (currentEstado === 'Verde') {
                    newEstado = 'Rojo';
                } else { // Rojo
                    newEstado = 'Gris';
                }

                const sociosCollectionRef = getSociosCollectionRef();
                if (!sociosCollectionRef) return;

                const socioRef = doc(sociosCollectionRef, socioId);
                await updateDoc(socioRef, {
                    estado: newEstado,
                    fecha_caducidad_pago: fechaCaducidad
                });
            }

            if (e.target.classList.contains('view-id-btn')) {
                const photoUrl = e.target.dataset.url;
                if (photoUrl) {
                    const viewIdModal = document.getElementById('view-id-modal');
                    const idPhotoContainer = document.getElementById('id-photo-container');
                    idPhotoContainer.src = photoUrl;
                    viewIdModal.classList.remove('hidden');
                }
            }
        });

        document.getElementById('close-view-id-modal').addEventListener('click', () => {
            document.getElementById('view-id-modal').classList.add('hidden');
        });

        document.getElementById('show-add-socio-modal').addEventListener('click', () => addSocioModal.classList.remove('hidden'));
        document.getElementById('cancel-add-socio').addEventListener('click', () => {
            addSocioForm.reset();
            addSocioModal.classList.add('hidden');
        });

        // --- MÓDULO DE ARTÍCULOS (STOCK) ---
        const addArticleForm = document.getElementById('add-article-form');
        const articlesList = document.getElementById('articles-list');

        function listenToArticles() {
            const q = query(collection(db, "articulos"), orderBy("categoria"), orderBy("nombre"));

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    articlesList.innerHTML = '<p class="text-gray-500 text-center">No hay artículos en el inventario.</p>';
                    return;
                }

                const articlesByCat = snapshot.docs.reduce((acc, doc) => {
                    const article = { id: doc.id, ...doc.data() };
                    const category = article.categoria || 'Sin Categoría';
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(article);
                    return acc;
                }, {});

                articlesList.innerHTML = '';

                for (const category in articlesByCat) {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.className = 'bg-gray-800 p-4 rounded-lg';

                    const categoryTitle = document.createElement('h3');
                    categoryTitle.className = 'text-xl font-semibold mb-3 text-blue-400 border-b border-gray-700 pb-2';
                    categoryTitle.textContent = category;
                    categoryContainer.appendChild(categoryTitle);

                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'space-y-2 mt-3';

                    articlesByCat[category].forEach(article => {
                        const articleElement = document.createElement('div');
                        articleElement.className = 'grid grid-cols-1 sm:grid-cols-4 items-center gap-4 p-2 rounded-md hover:bg-gray-700/50';

                        const precio = article.precioPorUnidad || 0;
                        const unidad = article.unidadMinimaVenta || 1;

                        articleElement.innerHTML = `
                            <div class="sm:col-span-2">
                                <p class="font-medium">${article.nombre}</p>
                                <p class="text-xs text-gray-400">${precio.toFixed(2)}€ / ${unidad} ud.</p>
                            </div>
                            <p>Stock: <span class="font-bold">${article.stock}</span></p>
                            <div class="flex items-center gap-2">
                                <input type="number" min="1" placeholder="Cant." class="stock-input bg-gray-600 border border-gray-500 text-white sm:text-sm rounded-lg w-20 p-1.5" data-id="${article.id}">
                                <button class="load-stock-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg" data-id="${article.id}" data-name="${article.nombre}">Cargar</button>
                            </div>
                        `;
                        itemsContainer.appendChild(articleElement);
                    });

                    categoryContainer.appendChild(itemsContainer);
                    articlesList.appendChild(categoryContainer);
                }
            });
        }

        addArticleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('article-nombre').value.trim();
            const categoria = document.getElementById('article-categoria').value.trim();
            const unidadMinimaVenta = Number(document.getElementById('article-unidad').value);
            const precioPorUnidad = Number(document.getElementById('article-precio').value);

            if (!nombre || !categoria || !unidadMinimaVenta || !precioPorUnidad) {
                alert("Por favor, completa todos los campos.");
                return;
            }

            try {
                await addDoc(collection(db, "articulos"), {
                    nombre,
                    categoria,
                    unidadMinimaVenta,
                    precioPorUnidad,
                    stock: 0,
                    createdAt: serverTimestamp()
                });
                await logAction(`Añadió el artículo: ${nombre}`);
                addArticleForm.reset();
            } catch (error) {
                console.error("Error adding article: ", error);
                alert("Hubo un error al añadir el artículo.");
            }
        });

        articlesList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('load-stock-btn')) {
                const articleId = e.target.dataset.id;
                const articleName = e.target.dataset.name;
                const input = articlesList.querySelector(`.stock-input[data-id="${articleId}"]`);
                const quantity = Number(input.value);

                if (!input || !quantity || quantity <= 0) {
                    alert("Por favor, introduce una cantidad válida.");
                    return;
                }

                const articleRef = doc(db, "articulos", articleId);

                try {
                    await updateDoc(articleRef, {
                        stock: increment(quantity)
                    });
                    await logAction(`Cargó ${quantity} uds. de ${articleName} (stock)`);
                    input.value = '';
                } catch (error) {
                    console.error("Error updating stock: ", error);
                    alert("Error al actualizar el stock.");
                }
            }
        });


        // --- MÓDULO DE HISTORIAL (LOGS) ---
        const logsList = document.getElementById('logs-list');

        async function logAction(actionText) {
            if (!currentUser) return;
            try {
                await addDoc(collection(db, "logs"), {
                    action: actionText,
                    user: currentUser.email,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error logging action:", error);
            }
        }
        
        function listenToLogs() {
            const q = query(collection(db, "logs"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                logsList.innerHTML = '';
                if(snapshot.empty) {
                    logsList.innerHTML = '<p class="text-gray-500 text-center">No hay acciones registradas.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const logDate = log.timestamp?.toDate().toLocaleString('es-ES') || 'Fecha pendiente...';
                    const logElement = `
                        <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                            <p><span class="font-bold text-blue-400">${log.user}</span>: ${log.action}</p>
                            <p class="text-gray-400">${logDate}</p>
                        </div>
                    `;
                    logsList.innerHTML += logElement;
                });
            });
        }
        
    </script>
</body>
</html>