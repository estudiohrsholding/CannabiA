<!DOCTYPE html>
<html lang="es" class="bg-gray-900 text-white">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor del Club v2</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .view { transition: opacity 0.3s ease-in-out; }
    </style>
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="min-h-screen flex flex-col items-center justify-center bg-slate-900 p-4">

    <div id="loading-view" class="flex items-center justify-center h-screen">
        <p class="text-xl">Cargando aplicación...</p>
    </div>

    <div id="login-view" class="hidden w-full max-w-sm mx-auto mt-20">
        <div class="bg-slate-800 p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">Iniciar Sesión</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block mb-2 text-sm font-medium text-slate-300">Email</label>
                    <input type="email" id="login-email" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block mb-2 text-sm font-medium text-slate-300">Contraseña</label>
                    <input type="password" id="login-password" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Entrar</button>
                <p id="login-error" class="text-red-500 text-center mt-4"></p>
            </form>
        </div>
    </div>
    <div id="load-stock-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div id="load-stock-modal-content" class="relative bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md z-50">
            <h2 id="load-stock-modal-title" class="text-2xl font-bold mb-4">Cargando stock para: </h2>
            <form id="load-stock-form">
                <div id="form-error" class="hidden text-red-400 text-sm mb-4 p-3 bg-red-900/50 rounded-lg"></div>
                <div class="mb-4">
                    <label for="stock-cantidad-input" class="block mb-2 text-sm font-medium text-slate-300">Cantidad a Cargar</label>
                    <input type="number" id="stock-cantidad-input" min="1" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-load-stock" class="bg-slate-600 hover:bg-slate-700 py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" id="confirm-load-stock-btn" class="bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg">Confirmar Carga</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" class="w-full max-w-7xl mx-auto">
        <div id="view-id-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="bg-slate-800 p-8 rounded-lg shadow-lg w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Foto del ID</h2>
                <img id="id-photo-container" src="" alt="Foto del ID" class="rounded-lg max-h-96 mx-auto"/>
                <div class="flex justify-end mt-4">
                    <button type="button" id="close-view-id-modal" class="bg-slate-600 hover:bg-slate-700 py-2 px-4 rounded">Cerrar</button>
                </div>
            </div>
        </div>
        <header class="flex justify-between items-center mb-6">
            <h1 id="view-title" class="text-3xl font-bold">Menú Principal</h1>
            <div>
                <button id="back-to-menu" class="hidden bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg mr-4">← Volver</button>
                <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
            </div>
        </header>

        <main>
            <section id="main-menu-view" class="view">
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 text-center">
                <div data-view="socios" class="menu-item bg-slate-800 p-6 rounded-lg hover:bg-slate-700 cursor-pointer transition-transform transform hover:-translate-y-1">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <h2 class="text-xl font-semibold">Socios</h2>
                    </div>
                    <div data-view="articulos-section" class="menu-item bg-slate-800 p-6 rounded-lg hover:bg-slate-700 cursor-pointer transition-transform transform hover:-translate-y-1">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        <h2 class="text-xl font-semibold">Artículos</h2>
                    </div>
                    <div data-view="tpv-section" class="menu-item bg-slate-800 p-6 rounded-lg hover:bg-slate-700 cursor-pointer transition-transform transform hover:-translate-y-1">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        <h2 class="text-xl font-semibold">TPV</h2>
                    </div>
                    <div data-view="stats-view" class="menu-item bg-slate-800 p-6 rounded-lg hover:bg-slate-700 cursor-pointer transition-transform transform hover:-translate-y-1">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <h2 class="text-xl font-semibold">Estadísticas</h2>
                    </div>
                    <div data-view="historial-section" class="menu-item bg-slate-800 p-6 rounded-lg hover:bg-slate-700 cursor-pointer transition-transform transform hover:-translate-y-1">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h2 class="text-xl font-semibold">Historial</h2>
                    </div>
                </div>
            </section>

            <section id="socios" class="view hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Socios</h2>
                </div>
                <input type="search" id="search-socios" placeholder="Buscar socio por nombre..." class="w-full p-2 mb-4 bg-slate-700 rounded-lg border border-slate-600">
                <div id="socios-list" class="space-y-2">
                    <!-- Los socios se renderizarán aquí como tarjetas -->
                </div>
            </section>
            
            <section id="articulos-section" class="view hidden space-y-8">
                <div>
                    <h2 class="text-2xl font-bold mb-4">Inventario</h2>
                    <input type="search" id="search-articulos" placeholder="Buscar artículo por nombre..." class="w-full p-2 mb-4 bg-slate-700 rounded-lg border border-slate-600">
                    <div id="lista-articulos-container" class="space-y-6">
                        <!-- Los artículos se renderizarán aquí -->
                    </div>
                </div>
            </section>
            <section id="tpv-section" class="view hidden">
                <div class="bg-slate-800 p-6 rounded-lg text-slate-100">
                    <h2 class="text-2xl font-bold mb-6">Punto de Dispensa</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Columna de Selección -->
                        <div class="space-y-4">
                            <div>
                                <label for="tpv-socio-input" class="block mb-2 text-sm font-medium">Buscar Socio</label>
                                <input id="tpv-socio-input" list="tpv-socios-datalist" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Escribe para buscar...">
                                <datalist id="tpv-socios-datalist"></datalist>
                            </div>
                            <div>
                                <label for="tpv-articulo-input" class="block mb-2 text-sm font-medium">Buscar Artículo</label>
                                <input id="tpv-articulo-input" list="tpv-articulos-datalist" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Escribe para buscar...">
                                <datalist id="tpv-articulos-datalist"></datalist>
                            </div>
                            <div>
                                <label for="tpv-cantidad" class="block mb-2 text-sm font-medium">Cantidad</label>
                                <input type="number" id="tpv-cantidad" min="1" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                        </div>

                        <!-- Columna de Resumen y Dispensa -->
                        <div class="space-y-6 flex flex-col justify-between">
                            <div id="tpv-resumen-pedido" class="bg-slate-700 p-4 mt-6 rounded-md">
                                <h3 class="text-lg font-bold mb-4 border-b border-slate-600 pb-2">Resumen de Dispensa</h3>
                                <div class="space-y-3">
                                    <p>Socio: <span id="resumen-socio" class="font-semibold">--</span></p>
                                    <p>Artículo: <span id="resumen-articulo" class="font-semibold">--</span></p>
                                    <p>Cantidad: <span id="resumen-cantidad" class="font-semibold">--</span></p>
                                    <div class="border-t border-slate-600 pt-3 mt-3">
                                        <p class="flex justify-between items-center text-xl">
                                            <span>Aporte por Dispensa:</span>
                                            <strong id="resumen-total" class="text-2xl text-green-400">0.00 €</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <button id="realizar-dispensa-btn" disabled class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg disabled:bg-slate-500 disabled:cursor-not-allowed">
                                REALIZAR DISPENSA
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="stats-view" class="view hidden">
                <h2 class="text-2xl font-bold mb-4">Estadísticas de Dispensas (Últimos 7 días)</h2>
                <div class="bg-gray-800 p-6 rounded-lg">
                    <canvas id="grafico-ventas-semanal"></canvas>
                </div>
            </section>
            
            <section id="historial-section" class="view hidden">
                 <h2 class="text-2xl font-bold mb-4">Historial de Operaciones</h2>
                 <div id="historial-container" class="space-y-4">
                     <!-- El historial de eventos se renderizará aquí -->
                 </div>
            </section>
        </main>
    </div>
    
    <!-- FABs -->
    <button id="fab-add-socio" class="hidden fixed bottom-8 right-8 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full p-4 shadow-lg z-30 text-2xl w-16 h-16 flex items-center justify-center">+</button>
    <button id="fab-add-articulo" class="hidden fixed bottom-8 right-8 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full p-4 shadow-lg z-30 text-2xl w-16 h-16 flex items-center justify-center">+</button>

    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>

    <!-- Add Article Modal -->
    <div id="add-articulo-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="relative bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md z-50">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Añadir Artículo</h2>
                <button id="close-add-articulo-modal" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="form-articulo">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="article-nombre" class="block mb-2 text-sm font-medium text-slate-300">Nombre</label>
                        <input type="text" id="article-nombre" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="article-categoria" class="block mb-2 text-sm font-medium text-slate-300">Categoría</label>
                        <input list="categorias-datalist" type="text" id="article-categoria" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        <datalist id="categorias-datalist"></datalist>
                    </div>
                    <div>
                        <label for="article-unidad" class="block mb-2 text-sm font-medium text-slate-300">Unidad Mínima de Dispensa</label>
                        <input type="number" id="article-unidad" min="0.1" step="0.1" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="article-precio" class="block mb-2 text-sm font-medium text-slate-300">Precio por Unidad (€)</label>
                        <input type="number" id="article-precio" min="0" step="0.01" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                </div>
                <div class="mt-6 text-right">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Añadir Artículo</button>
                </div>
            </form>
        </div>
    </div>


    <div id="add-socio-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div id="add-socio-modal-content" class="relative bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md z-50">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Añadir Socio</h2>
                <button id="close-add-socio-modal" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="add-socio-form" novalidate>
                <div id="form-error" class="hidden text-red-400 text-sm mb-4 p-3 bg-red-900/50 rounded-lg"></div>
                <div class="mb-4">
                    <label for="socio-nombre" class="block mb-2 text-sm font-medium text-slate-300">Nombre</label>
                    <input type="text" id="socio-nombre" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    <div id="error-nombre" class="text-red-400 text-sm mt-1"></div>
                </div>
                <div class="mb-4">
                    <label for="socio-apellido" class="block mb-2 text-sm font-medium text-slate-300">Apellido</label>
                    <input type="text" id="socio-apellido" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    <div id="error-apellido" class="text-red-400 text-sm mt-1"></div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 text-sm font-medium text-slate-300">Foto del ID</label>
                    <div id="photo-preview-container" class="hidden w-full h-48 bg-slate-700 rounded-lg mb-2 flex items-center justify-center">
                        <img id="photo-preview" src="" alt="Vista previa de la foto" class="hidden max-h-full max-w-full rounded-lg">
                        <span id="preview-text" class="text-slate-400">Vista previa</span>
                    </div>
                    <button type="button" id="take-photo-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-2">
                        Tomar Foto
                    </button>
                    <div class="text-center">
                        <a href="#" id="upload-file-link" class="text-sm text-blue-400 hover:underline">o sube un archivo</a>
                    </div>
                    <input type="file" id="socio-id-photo" accept="image/*" class="hidden" required>
                    <div id="error-foto" class="text-red-400 text-sm mt-1"></div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-add-socio" class="bg-slate-600 hover:bg-slate-700 py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" id="submit-socio-btn" class="bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg flex items-center">
                        <span class="btn-text">Guardar</span>
                        <svg class="spinner hidden w-5 h-5 ml-2 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalles del Socio -->
    <div id="socio-details-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-40 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-2xl z-50 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                <h2 id="socio-details-modal-title" class="text-2xl font-bold">Detalles del Socio</h2>
                <button id="close-socio-details-modal" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="socio-details-content" class="overflow-y-auto">
                <!-- El contenido se cargará aquí dinámicamente -->
                <p class="text-center p-8">Cargando historial...</p>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6">
            <h2 id="confirmation-modal-title" class="text-xl font-bold mb-4">Confirmar Acción</h2>
            <p id="confirmation-modal-message" class="text-slate-300 mb-6">¿Estás seguro de que quieres continuar?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmation-modal-cancel-btn" class="bg-slate-600 hover:bg-slate-700 py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirmation-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-4">Capturar Foto</h2>
            <div id="camera-container" class="relative">
                <video id="camera-feed" class="w-full h-auto rounded-lg bg-slate-900" autoplay playsinline></video>
                <canvas id="photo-canvas" class="hidden"></canvas>
                <div id="camera-preview-overlay" class="hidden absolute inset-0 flex items-center justify-center">
                    <img id="camera-preview" src="" class="max-h-full max-w-full rounded-lg">
                </div>
            </div>
            <div id="camera-error" class="text-red-400 text-center my-2"></div>
            <div id="camera-controls" class="flex justify-center items-center space-x-4 mt-4">
                <button id="capture-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg">Capturar</button>
            </div>
            <div id="preview-controls" class="hidden flex justify-center items-center space-x-4 mt-4">
                <button id="retake-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg">Volver a tomar</button>
                <button id="use-photo-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Usar esta foto</button>
            </div>
            <div class="text-center mt-4">
                 <button id="close-camera-modal" class="text-slate-400 hover:text-white">Cancelar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importa las funciones que necesitas de los SDKs de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, query, orderBy, setDoc, increment, runTransaction, getDoc, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // ==========================================================================================
        // 🔥 ¡ATENCIÓN! REEMPLAZA ESTE OBJETO CON TU CONFIGURACIÓN REAL DE FIREBASE
        // Tu configuración la encuentras en: Consola de Firebase > Configuración del proyecto (⚙️)
        // ==========================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCCIRk9Vip1J5Zc8xAeObsU6poc-J8lcj0",
            authDomain: "cannabia-9dfe3.firebaseapp.com",
            projectId: "cannabia-9dfe3",
            storageBucket: "cannabia-9dfe3.firebasestorage.app",
            messagingSenderId: "605207982385",
            appId: "1:605207982385:web:58254637495b2b6d2bc010",
            measurementId: "G-6M1WRYG1PS"
        };

        // --- Verificación de Configuración ---
        // Esta comprobación te alertará si olvidas reemplazar la configuración de ejemplo.
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIza...")) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'fixed top-0 left-0 w-full p-4 bg-red-800 text-white text-center text-lg z-50';
            warningDiv.textContent = "¡ERROR DE CONFIGURACIÓN! Reemplaza el objeto 'firebaseConfig' de ejemplo en index.html con el tuyo.";
            document.body.prepend(warningDiv);
            // Detenemos la ejecución para prevenir errores más complejos
            throw new Error("Configuración de Firebase no válida o ausente.");
        }

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentUser = null;

        // --- GESTIÓN DE VISTAS (BLOQUE CORREGIDO) ---
        const views = document.querySelectorAll('.view');
        const menuItems = document.querySelectorAll('.menu-item');
        const viewTitle = document.getElementById('view-title');
        const backToMenuBtn = document.getElementById('back-to-menu');
        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const fabAddSocio = document.getElementById('fab-add-socio');
        const fabAddArticulo = document.getElementById('fab-add-articulo');

        function showView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.remove('hidden');
                
                const isMenuView = viewId === 'main-menu-view';
                backToMenuBtn.classList.toggle('hidden', isMenuView);

                // Control FAB visibility
                fabAddSocio.classList.toggle('hidden', viewId !== 'socios');
                fabAddArticulo.classList.toggle('hidden', viewId !== 'articulos-section');
                
                if (isMenuView) {
                    viewTitle.textContent = 'Menú Principal';
                } else {
                    viewTitle.textContent = activeView.querySelector('h2').textContent;
                }

                // Si la vista es la de estadísticas, renderizar el gráfico
                if (viewId === 'stats-view') {
                    renderizarGraficoDispensas();
                }
            }
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const viewId = item.dataset.view;
                showView(viewId);
            });
        });

        backToMenuBtn.addEventListener('click', () => showView('main-menu-view'));

        // --- LÓGICA DE AUTENTICACIÓN ---
        setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, user => {
            loadingView.classList.add('hidden');
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                showView('main-menu-view');
                listenToSocios();
                listenToHistory();
                listenToArticles();
                listenToSociosForTPV();
                listenToArticlesForTPV();
            } else {
                currentUser = null;
                appContainer.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = 'Credenciales incorrectas.';
                console.error("Login Error:", error);
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));
        
        // --- MÓDULO DE SOCIOS ---
        const sociosList = document.getElementById('socios-list');
        const addSocioModalOverlay = document.getElementById('add-socio-modal-overlay');
        const addSocioForm = document.getElementById('add-socio-form');
        const socioIdPhotoInput = document.getElementById('socio-id-photo');
        const closeAddSocioModalBtn = document.getElementById('close-add-socio-modal');
        const cancelAddSocioBtn = document.getElementById('cancel-add-socio');
        const socioDetailsModalOverlay = document.getElementById('socio-details-modal-overlay');
        const socioDetailsModalTitle = document.getElementById('socio-details-modal-title');
        const socioDetailsContent = document.getElementById('socio-details-content');
        const closeSocioDetailsModalBtn = document.getElementById('close-socio-details-modal');
        const searchSociosInput = document.getElementById('search-socios');
        const searchArticulosInput = document.getElementById('search-articulos');

        searchSociosInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const socios = sociosList.querySelectorAll('.socio-card');
            socios.forEach(socio => {
                const nombre = socio.dataset.nombre.toLowerCase();
                if (nombre.includes(searchTerm)) {
                    socio.classList.remove('hidden');
                } else {
                    socio.classList.add('hidden');
                }
            });
        });

        searchArticulosInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const categorias = listaArticulosContainer.querySelectorAll('.bg-slate-800'); // Contenedor de cada categoría
            categorias.forEach(categoria => {
                const items = categoria.querySelectorAll('.grid');
                let hasVisibleItem = false;
                items.forEach(item => {
                    const nombre = item.textContent.toLowerCase();
                    if (nombre.includes(searchTerm)) {
                        item.classList.remove('hidden');
                        hasVisibleItem = true;
                    } else {
                        item.classList.add('hidden');
                    }
                });
                // Si ninguna tarjeta de artículo es visible en una categoría, oculta el título de la categoría
                if (hasVisibleItem) {
                    categoria.classList.remove('hidden');
                } else {
                    categoria.classList.add('hidden');
                }
            });
        });


        async function showPartnerDetails(socioId, socioNombre) {
            socioDetailsModalTitle.textContent = `Historial de ${socioNombre}`;
            socioDetailsModalOverlay.classList.remove('hidden');
            socioDetailsContent.innerHTML = '<p class="text-center p-8">Cargando historial...</p>';

            try {
                const dispensasRef = collection(db, "dispensas");
                const q = query(dispensasRef, where("idSocio", "==", socioId), orderBy("fecha", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    socioDetailsContent.innerHTML = '<p class="text-center p-8 text-slate-400">Este socio no tiene dispensas registradas.</p>';
                    return;
                }

                let html = '<div class="space-y-3">';
                querySnapshot.forEach(doc => {
                    const dispensa = doc.data();
                    const fecha = formatFirebaseTimestamp(dispensa.fecha);
                    html += `
                        <div class="bg-slate-700 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${dispensa.nombreArticulo}</p>
                                <p class="text-sm text-slate-400">${fecha}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-400">${dispensa.precioTotal.toFixed(2)} €</p>
                                <p class="text-sm text-slate-300">Cantidad: ${dispensa.cantidad}</p>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                socioDetailsContent.innerHTML = html;

            } catch (error) {
                console.error("Error al obtener el historial del socio:", error);
                socioDetailsContent.innerHTML = '<p class="text-center p-8 text-red-500">No se pudo cargar el historial. Inténtalo de nuevo.</p>';
                showToast("Error al cargar el historial.", true);
            }
        }

        function closeSocioDetailsModal() {
            socioDetailsModalOverlay.classList.add('hidden');
            socioDetailsContent.innerHTML = '<p class="text-center p-8">Cargando historial...</p>'; // Reset content
        }

        closeSocioDetailsModalBtn.addEventListener('click', closeSocioDetailsModal);
        socioDetailsModalOverlay.addEventListener('click', (e) => {
            if (e.target === socioDetailsModalOverlay) {
                closeSocioDetailsModal();
            }
        });


        function getSociosCollectionRef() {
            if (!currentUser || !firebaseConfig.appId) {
                console.error("User not logged in or appId not configured");
                return null;
            }
            return collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/socios`);
        }

        function optimizeImage(file, maxSize = 1024, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function listenToSocios() {
            const sociosCollectionRef = getSociosCollectionRef();
            if (!sociosCollectionRef) return;

            const q = query(sociosCollectionRef, orderBy("apellido", "asc"));
            onSnapshot(q, (snapshot) => {
                sociosList.innerHTML = '';
                if (snapshot.empty) {
                    sociosList.innerHTML = '<p class="text-center text-slate-500">No hay socios registrados.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const socio = doc.data();
                    const hoy = new Date();
                    let estadoFinal = socio.estado;

                    if (socio.estado === 'Verde' && socio.fecha_caducidad_pago && socio.fecha_caducidad_pago.toDate() < hoy) {
                        estadoFinal = 'Gris';
                    }

                    const statusInfo = {
                        'Gris': { color: 'bg-slate-500', text: 'Pendiente' },
                        'Rojo': { color: 'bg-red-500', text: 'Non Grata' },
                        'Verde': { color: 'bg-green-500', text: 'Pagado' }
                    };
                    const currentStatus = statusInfo[estadoFinal];

                    const socioCard = document.createElement('div');
                    socioCard.className = 'socio-card p-4 bg-slate-800 rounded-lg flex justify-between items-center border-b border-slate-700';
                    socioCard.dataset.id = doc.id;
                    socioCard.dataset.nombre = `${socio.nombre} ${socio.apellido}`;


                    socioCard.innerHTML = `
                        <div class="flex items-center">
                            <div>
                                <p class="font-semibold text-white">${socio.nombre} ${socio.apellido}</p>
                                <span class="px-2 py-1 text-xs font-semibold leading-tight text-white rounded-full ${currentStatus.color}">
                                    ${currentStatus.text}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${doc.id}" data-estado="${socio.estado}" class="change-status-btn text-blue-400 hover:underline">Cambiar Estado</button>
                            <button data-id="${doc.id}" data-nombre="${socio.nombre} ${socio.apellido}" class="view-details-btn text-blue-400 hover:underline ml-4">Ver Detalles</button>
                            <button data-id="${doc.id}" class="edit-socio-btn p-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-white">✏️</button>
                            <button data-id="${doc.id}" data-nombre="${socio.nombre} ${socio.apellido}" class="delete-socio-btn p-2 bg-red-600 hover:bg-red-700 rounded-lg text-white">🗑️</button>
                        </div>
                    `;
                    sociosList.appendChild(socioCard);
                });
            });
        }

        async function deleteSocio(socioId, socioNombre) {
            const sociosCollectionRef = getSociosCollectionRef();
            if (!sociosCollectionRef) return;
            try {
                await deleteDoc(doc(sociosCollectionRef, socioId));
                showToast(`Socio "${socioNombre}" eliminado correctamente.`);
            } catch (error) {
                console.error("Error deleting socio: ", error);
                showToast("Error al eliminar el socio.", true);
            }
        }

        async function handleEditSocio(socioId) {
            const sociosCollectionRef = getSociosCollectionRef();
            if (!sociosCollectionRef) return;
            try {
                const socioRef = doc(sociosCollectionRef, socioId);
                const socioSnap = await getDoc(socioRef);
                if (socioSnap.exists()) {
                    const data = socioSnap.data();
                    editingSocioId = socioId;

                    document.getElementById('socio-nombre').value = data.nombre;
                    document.getElementById('socio-apellido').value = data.apellido;

                    // Reset and update modal UI for editing
                    addSocioForm.reset(); // First reset to clear validation states if any
                    document.getElementById('socio-nombre').value = data.nombre;
                    document.getElementById('socio-apellido').value = data.apellido;
                    document.getElementById('error-foto').textContent = 'Dejar en blanco para no cambiar la foto.';


                    addSocioModalOverlay.querySelector('h2').textContent = 'Editar Socio';
                    addSocioModalOverlay.querySelector('button[type="submit"] .btn-text').textContent = 'Guardar Cambios';
                    addSocioModalOverlay.classList.remove('hidden');
                } else {
                    showToast("El socio que intentas editar ya no existe.", true);
                }
            } catch (error) {
                console.error("Error fetching socio for edit: ", error);
                showToast("Error al cargar los datos del socio.", true);
            }
        }

        fabAddSocio.addEventListener('click', () => {
            editingSocioId = null;
            addSocioForm.reset();
            document.getElementById('error-foto').textContent = '';
            addSocioModalOverlay.querySelector('h2').textContent = 'Añadir Socio';
            addSocioModalOverlay.querySelector('button[type="submit"] .btn-text').textContent = 'Guardar';
            addSocioModalOverlay.classList.remove('hidden');
        });

        addSocioForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validación
            const nombre = document.getElementById('socio-nombre').value.trim();
            const apellido = document.getElementById('socio-apellido').value.trim();
            const fileFromInput = socioIdPhotoInput.files[0];
            const imageFile = capturedImageFile || fileFromInput;
            let isValid = true;

            // Limpiar errores previos
            document.getElementById('error-nombre').textContent = '';
            document.getElementById('error-apellido').textContent = '';
            document.getElementById('error-foto').textContent = '';
            document.getElementById('form-error').classList.add('hidden');

            if (!nombre) {
                document.getElementById('error-nombre').textContent = 'El nombre es obligatorio.';
                isValid = false;
            }
            if (!apellido) {
                document.getElementById('error-apellido').textContent = 'El apellido es obligatorio.';
                isValid = false;
            }
            if (!editingSocioId && !imageFile) { // Photo is required only when creating a new member
                document.getElementById('error-foto').textContent = 'La foto del DNI es obligatoria.';
                isValid = false;
            }

            if (!isValid) return;

            const submitBtn = document.getElementById('submit-socio-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const spinner = submitBtn.querySelector('.spinner');

            // --- Feedback de envío ---
            submitBtn.disabled = true;
            btnText.textContent = 'Guardando...';
            spinner.classList.remove('hidden');

            try {
                const sociosCollectionRef = getSociosCollectionRef();
                if (!sociosCollectionRef) {
                    throw new Error('Error de autenticación. Inténtalo de nuevo.');
                }

                if (editingSocioId) {
                    // Update existing socio
                    const socioRef = doc(sociosCollectionRef, editingSocioId);
                    const socioData = { nombre, apellido };

                    if (imageFile) {
                        const optimizedBlob = await optimizeImage(imageFile);
                        const storageRef = ref(storage, `socios_ids/${editingSocioId}.jpg`);
                        await uploadBytes(storageRef, optimizedBlob);
                        socioData.url_foto_id = await getDownloadURL(storageRef);
                    }

                    await updateDoc(socioRef, socioData);
                    showToast('Socio actualizado correctamente.');

                } else {
                    // Create new socio
                    const newSocioRef = doc(sociosCollectionRef);
                    const newSocioData = {
                        nombre,
                        apellido,
                        estado: 'Gris',
                        fecha_ingreso: serverTimestamp(),
                        fecha_caducidad_pago: null,
                        url_foto_id: ''
                    };
                    await setDoc(newSocioRef, newSocioData);

                    const optimizedBlob = await optimizeImage(imageFile);
                    const storageRef = ref(storage, `socios_ids/${newSocioRef.id}.jpg`);
                    await uploadBytes(storageRef, optimizedBlob);
                    const downloadURL = await getDownloadURL(storageRef);

                    await updateDoc(newSocioRef, { url_foto_id: downloadURL });
                    showToast('Socio añadido correctamente.');
                }

                closeSocioModal();
                editingSocioId = null;

            } catch (error) {
                console.error("Error al guardar el socio:", error);
                showToast('Error al guardar el socio.', true);
                const formError = document.getElementById('form-error');
                if (formError) {
                    formError.textContent = error.message;
                    formError.classList.remove('hidden');
                }
            } finally {
                // --- Restaurar botón ---
                submitBtn.disabled = false;
                btnText.textContent = 'Guardar';
                spinner.classList.add('hidden');
            }
        });

        sociosList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const socioId = target.dataset.id;

            if (target.classList.contains('change-status-btn')) {
                let currentEstado = target.dataset.estado;
                let newEstado;
                let fechaCaducidad = null;

                if (currentEstado === 'Gris') {
                    newEstado = 'Verde';
                    const futureDate = new Date();
                    futureDate.setDate(futureDate.getDate() + 365);
                    fechaCaducidad = futureDate;
                } else if (currentEstado === 'Verde') {
                    newEstado = 'Rojo';
                } else { // Rojo
                    newEstado = 'Gris';
                }

                const sociosCollectionRef = getSociosCollectionRef();
                if (!sociosCollectionRef) return;

                const socioRef = doc(sociosCollectionRef, socioId);
                await updateDoc(socioRef, {
                    estado: newEstado,
                    fecha_caducidad_pago: fechaCaducidad
                });
            } else if (target.classList.contains('view-details-btn')) {
                const socioNombre = target.dataset.nombre;
                showPartnerDetails(socioId, socioNombre);
            } else if (target.classList.contains('edit-socio-btn')) {
                handleEditSocio(socioId);
            } else if (target.classList.contains('delete-socio-btn')) {
                const socioNombre = target.dataset.nombre;
                showConfirmationModal(
                    'Eliminar Socio',
                    `¿Estás seguro de que quieres eliminar a ${socioNombre}? Se eliminarán todos sus datos.`,
                    () => deleteSocio(socioId, socioNombre)
                );
            }
        });

        document.getElementById('close-view-id-modal').addEventListener('click', () => {
            document.getElementById('view-id-modal').classList.add('hidden');
        });

        // --- TOAST NOTIFICATION ---
        function showToast(message, isError = false) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const baseClasses = 'p-4 rounded-lg shadow-lg text-white mb-2 transition-all duration-300';
            const bgColor = isError ? 'bg-red-600' : 'bg-green-600';
            toast.className = `${baseClasses} ${bgColor}`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function closeSocioModal() {
            addSocioForm.reset();
            addSocioModalOverlay.classList.add('hidden');
            // Limpiar errores
            document.getElementById('error-nombre').textContent = '';
            document.getElementById('error-apellido').textContent = '';
            document.getElementById('error-foto').textContent = '';
            document.getElementById('form-error').classList.add('hidden');
        }

        cancelAddSocioBtn.addEventListener('click', closeSocioModal);
        closeAddSocioModalBtn.addEventListener('click', closeSocioModal);

        addSocioModalOverlay.addEventListener('click', (e) => {
            if (e.target === addSocioModalOverlay) {
                closeSocioModal();
            }
        });

        fabAddSocio.addEventListener('click', () => {
            addSocioModalOverlay.classList.remove('hidden');
        });

        // --- MÓDULO DE ARTÍCULOS (STOCK) ---
        const addArticuloModalOverlay = document.getElementById('add-articulo-modal-overlay');
        const closeAddArticuloModalBtn = document.getElementById('close-add-articulo-modal');
        const formArticulo = document.getElementById('form-articulo');
        const listaArticulosContainer = document.getElementById('lista-articulos-container');
        const categoriasDatalist = document.getElementById('categorias-datalist');
        const loadStockModalOverlay = document.getElementById('load-stock-modal-overlay');
        const loadStockModalTitle = document.getElementById('load-stock-modal-title');
        const loadStockForm = document.getElementById('load-stock-form');
        const cancelLoadStockBtn = document.getElementById('cancel-load-stock');
        let currentArticleForStockLoad = null;
        let editingArticleId = null;
        let editingSocioId = null;
        let capturedImageFile = null;
        let mediaStream = null;

        const takePhotoBtn = document.getElementById('take-photo-btn');
        const cameraModal = document.getElementById('camera-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const closeCameraModalBtn = document.getElementById('close-camera-modal');
        const cameraError = document.getElementById('camera-error');

        async function startCamera() {
            cameraError.textContent = '';
            try {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraFeed.srcObject = mediaStream;
                cameraModal.classList.remove('hidden');
            } catch (err) {
                console.error("Error accessing camera:", err);
                let message = "No se pudo acceder a la cámara.";
                if (err.name === "NotAllowedError") {
                    message = "Permiso de cámara denegado. Por favor, actívalo en los ajustes de tu navegador.";
                } else if (err.name === "NotFoundError") {
                    message = "No se encontró ninguna cámara en este dispositivo.";
                }
                cameraError.textContent = message;
                cameraModal.classList.remove('hidden'); // Show modal to display the error
            }
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            cameraModal.classList.add('hidden');
        }

        takePhotoBtn.addEventListener('click', startCamera);
        closeCameraModalBtn.addEventListener('click', stopCamera);

        const photoCanvas = document.getElementById('photo-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const cameraControls = document.getElementById('camera-controls');
        const previewControls = document.getElementById('preview-controls');
        const retakeBtn = document.getElementById('retake-btn');
        const usePhotoBtn = document.getElementById('use-photo-btn');
        const cameraPreview = document.getElementById('camera-preview');
        const cameraPreviewOverlay = document.getElementById('camera-preview-overlay');


        captureBtn.addEventListener('click', () => {
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            context.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);

            cameraPreview.src = photoCanvas.toDataURL('image/jpeg');

            // Show preview, hide feed
            cameraFeed.classList.add('hidden');
            cameraPreviewOverlay.classList.remove('hidden');

            // Toggle controls
            cameraControls.classList.add('hidden');
            previewControls.classList.remove('hidden');
        });

        retakeBtn.addEventListener('click', () => {
            // Hide preview, show feed
            cameraFeed.classList.remove('hidden');
            cameraPreviewOverlay.classList.add('hidden');

            // Toggle controls
            previewControls.classList.add('hidden');
            cameraControls.classList.remove('hidden');
        });

        usePhotoBtn.addEventListener('click', () => {
            const MAX_DIMENSION = 1024;
            let width = photoCanvas.width;
            let height = photoCanvas.height;

            if (width > height) {
                if (width > MAX_DIMENSION) {
                    height *= MAX_DIMENSION / width;
                    width = MAX_DIMENSION;
                }
            } else {
                if (height > MAX_DIMENSION) {
                    width *= MAX_DIMENSION / height;
                    height = MAX_DIMENSION;
                }
            }

            const resizedCanvas = document.createElement('canvas');
            resizedCanvas.width = width;
            resizedCanvas.height = height;
            const ctx = resizedCanvas.getContext('2d');
            ctx.drawImage(photoCanvas, 0, 0, width, height);

            resizedCanvas.toBlob((blob) => {
                capturedImageFile = new File([blob], 'id_photo.jpg', { type: 'image/jpeg' });

                // Display in the form's preview area
                photoPreview.src = URL.createObjectURL(capturedImageFile);
                photoPreview.classList.remove('hidden');
                photoPreviewContainer.classList.remove('hidden');
                previewText.classList.add('hidden');

                // Clear the file input
                socioIdPhotoInput.value = '';

                stopCamera();
            }, 'image/jpeg', 0.8);
        });

        const uploadFileLink = document.getElementById('upload-file-link');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const photoPreview = document.getElementById('photo-preview');
        const previewText = document.getElementById('preview-text');

        uploadFileLink.addEventListener('click', (e) => {
            e.preventDefault();
            socioIdPhotoInput.click();
        });

        socioIdPhotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    photoPreview.src = event.target.result;
                    photoPreview.classList.remove('hidden');
                    photoPreviewContainer.classList.remove('hidden');
                    previewText.classList.add('hidden');
                    capturedImageFile = null; // Clear any previously captured photo
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Confirmation Modal Logic ---
        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmationModalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');
        const confirmationModalCancelBtn = document.getElementById('confirmation-modal-cancel-btn');
        let confirmationCallback = null;

        function showConfirmationModal(title, message, onConfirm) {
            confirmationModalTitle.textContent = title;
            confirmationModalMessage.textContent = message;
            confirmationCallback = onConfirm;
            confirmationModalOverlay.classList.remove('hidden');
        }

        function closeConfirmationModal() {
            confirmationModalOverlay.classList.add('hidden');
            confirmationCallback = null;
        }

        confirmationModalConfirmBtn.addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback();
            }
            closeConfirmationModal();
        });

        confirmationModalCancelBtn.addEventListener('click', closeConfirmationModal);
        confirmationModalOverlay.addEventListener('click', (e) => {
            if (e.target === confirmationModalOverlay) {
                closeConfirmationModal();
            }
        });


        fabAddArticulo.addEventListener('click', () => {
            editingArticleId = null;
            formArticulo.reset();
            addArticuloModalOverlay.querySelector('h2').textContent = 'Añadir Artículo';
            formArticulo.querySelector('button[type="submit"]').textContent = 'Añadir Artículo';
            addArticuloModalOverlay.classList.remove('hidden');
        });

        closeAddArticuloModalBtn.addEventListener('click', () => {
            addArticuloModalOverlay.classList.add('hidden');
            formArticulo.reset();
        });

        addArticuloModalOverlay.addEventListener('click', (e) => {
            if(e.target === addArticuloModalOverlay) {
                addArticuloModalOverlay.classList.add('hidden');
                formArticulo.reset();
            }
        });

        function openLoadStockModal(articleId, articleName) {
            currentArticleForStockLoad = { id: articleId, nombre: articleName };
            loadStockModalTitle.textContent = `Cargando stock para: ${articleName}`;
            loadStockModalOverlay.classList.remove('hidden');
        }

        function closeLoadStockModal() {
            loadStockForm.reset();
            currentArticleForStockLoad = null;
            loadStockModalOverlay.classList.add('hidden');
        }

        listaArticulosContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const articleElement = target.closest('.grid');
            const articleId = articleElement.dataset.id;
            const articleName = articleElement.dataset.nombre;

            if (target.classList.contains('load-stock-btn')) {
                openLoadStockModal(articleId, articleName);
            } else if (target.classList.contains('edit-article-btn')) {
                handleEditArticle(articleId);
            } else if (target.classList.contains('delete-article-btn')) {
                showConfirmationModal(
                    'Eliminar Artículo',
                    `¿Estás seguro de que quieres eliminar "${articleName}"? Esta acción no se puede deshacer.`,
                    () => deleteArticle(articleId, articleName)
                );
            }
        });

        async function deleteArticle(articleId, articleName) {
            try {
                await deleteDoc(doc(db, "articulos", articleId));
                showToast(`Artículo "${articleName}" eliminado correctamente.`);
            } catch (error) {
                console.error("Error deleting article: ", error);
                showToast("Error al eliminar el artículo.", true);
            }
        }

        async function handleEditArticle(articleId) {
            try {
                const articleRef = doc(db, "articulos", articleId);
                const articleSnap = await getDoc(articleRef);
                if (articleSnap.exists()) {
                    const data = articleSnap.data();
                    editingArticleId = articleId;

                    document.getElementById('article-nombre').value = data.nombre;
                    document.getElementById('article-categoria').value = data.categoria;
                    document.getElementById('article-unidad').value = data.unidadMinimaVenta;
                    document.getElementById('article-precio').value = data.precioPorUnidad;

                    addArticuloModalOverlay.querySelector('h2').textContent = 'Editar Artículo';
                    formArticulo.querySelector('button[type="submit"]').textContent = 'Guardar Cambios';
                    addArticuloModalOverlay.classList.remove('hidden');
                } else {
                    showToast("El artículo que intentas editar ya no existe.", true);
                }
            } catch (error) {
                console.error("Error fetching article for edit: ", error);
                showToast("Error al cargar los datos del artículo.", true);
            }
        }

        cancelLoadStockBtn.addEventListener('click', closeLoadStockModal);
        loadStockModalOverlay.addEventListener('click', (e) => {
            if (e.target === loadStockModalOverlay) {
                closeLoadStockModal();
            }
        });

        loadStockForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentArticleForStockLoad) return;

            const cantidadInput = document.getElementById('stock-cantidad-input');
            const cantidad = Number(cantidadInput.value);

            if (!cantidad || cantidad <= 0) {
                showToast("Por favor, introduce una cantidad positiva.", true);
                return;
            }

            const { id: articleId, nombre: articleName } = currentArticleForStockLoad;
            const articleRef = doc(db, "articulos", articleId);

            try {
                // 1. Actualizar stock atómicamente
                await updateDoc(articleRef, {
                    stock: increment(cantidad)
                });

                // 2. Registrar en historial
                await addDoc(collection(db, "historial"), {
                    tipo: "recarga",
                    descripcion: `Recarga de ${cantidad} uds. de "${articleName}"`,
                    fecha: serverTimestamp()
                });

                showToast(`Stock de "${articleName}" actualizado con éxito.`);
                closeLoadStockModal();
            } catch (error) {
                console.error("Error updating stock: ", error);
                showToast("Error al actualizar el stock.", true);
            }
        });

        function listenToArticles() {
            // FIX: Se elimina el orden compuesto para no depender de un índice de Firestore.
            // El orden se aplica ahora en el lado del cliente.
            const q = query(collection(db, "articulos"));

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listaArticulosContainer.innerHTML = '<p class="text-slate-500 text-center">No hay artículos en el inventario.</p>';
                    return;
                }

                const allCategories = new Set();
                const articulosPorCategoria = snapshot.docs.reduce((acc, doc) => {
                    const article = { id: doc.id, ...doc.data() };
                    const category = article.categoria || 'Sin Categoría';
                    allCategories.add(category);
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(article);
                    return acc;
                }, {});

                // Ordenar artículos dentro de cada categoría por nombre
                for (const category in articulosPorCategoria) {
                    articulosPorCategoria[category].sort((a, b) => a.nombre.localeCompare(b.nombre));
                }

                // Actualizar Datalist con categorías ordenadas
                categoriasDatalist.innerHTML = '';
                Array.from(allCategories).sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    categoriasDatalist.appendChild(option);
                });

                listaArticulosContainer.innerHTML = '';

                // Obtener y ordenar las claves de categoría para renderizar en orden
                const sortedCategories = Object.keys(articulosPorCategoria).sort((a, b) => a.localeCompare(b));

                for (const category of sortedCategories) {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.className = 'bg-slate-800 p-4 rounded-lg';

                    const categoryTitle = document.createElement('h2');
                    categoryTitle.className = 'text-xl font-semibold mb-3 text-blue-400 border-b border-slate-700 pb-2';
                    categoryTitle.textContent = category;
                    categoryContainer.appendChild(categoryTitle);

                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'space-y-2 mt-3';

                    articulosPorCategoria[category].forEach(article => {
                        const articleElement = document.createElement('div');
                        articleElement.className = 'grid grid-cols-1 sm:grid-cols-5 items-center gap-4 p-2 rounded-md hover:bg-slate-700/50';
                        articleElement.dataset.id = article.id;
                        articleElement.dataset.nombre = article.nombre;

                        const precio = article.precioPorUnidad || 0;
                        const stock = article.stock || 0;

                        articleElement.innerHTML = `
                            <div class="sm:col-span-2">
                                <p class="font-medium">${article.nombre}</p>
                                <p class="text-xs text-slate-400">Categoría: ${article.categoria} | Precio: ${precio.toFixed(2)}€</p>
                            </div>
                            <p>Stock: <span class="font-bold">${stock}</span></p>
                            <div class="sm:col-span-1">
                                <button class="load-stock-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full">
                                    Cargar
                                </button>
                            </div>
                            <div class="sm:col-span-1 flex space-x-2">
                                 <button class="edit-article-btn p-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg">✏️</button>
                                 <button class="delete-article-btn p-2 bg-red-600 hover:bg-red-700 rounded-lg">🗑️</button>
                            </div>
                        `;
                        itemsContainer.appendChild(articleElement);
                    });

                    categoryContainer.appendChild(itemsContainer);
                    listaArticulosContainer.appendChild(categoryContainer);
                }
            });
        }

        formArticulo.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('article-nombre').value.trim();
            const categoria = document.getElementById('article-categoria').value.trim();
            const unidadMinimaVenta = Number(document.getElementById('article-unidad').value);
            const precioPorUnidad = Number(document.getElementById('article-precio').value);

            if (!nombre || !categoria || !unidadMinimaVenta || precioPorUnidad < 0) {
                showToast("Por favor, completa todos los campos correctamente.", true);
                return;
            }

            const articleData = {
                nombre,
                categoria,
                unidadMinimaVenta,
                precioPorUnidad,
            };

            try {
                if (editingArticleId) {
                    // Update existing article
                    const articleRef = doc(db, "articulos", editingArticleId);
                    await updateDoc(articleRef, articleData);
                    showToast(`Artículo "${nombre}" actualizado con éxito.`);
                } else {
                    // Add new article
                    articleData.stock = 0;
                    articleData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "articulos"), articleData);
                    showToast(`Artículo "${nombre}" añadido con éxito.`);
                }
                formArticulo.reset();
                addArticuloModalOverlay.classList.add('hidden');
                editingArticleId = null;
            } catch (error) {
                console.error("Error saving article: ", error);
                showToast("Hubo un error al guardar el artículo.", true);
            }
        });


        // --- MÓDULO DE TPV ---
        const tpvSocioInput = document.getElementById('tpv-socio-input');
        const tpvArticuloInput = document.getElementById('tpv-articulo-input');
        const tpvSociosDatalist = document.getElementById('tpv-socios-datalist');
        const tpvArticulosDatalist = document.getElementById('tpv-articulos-datalist');
        const tpvCantidadInput = document.getElementById('tpv-cantidad');
        const resumenSocio = document.getElementById('resumen-socio');
        const resumenArticulo = document.getElementById('resumen-articulo');
        const resumenCantidad = document.getElementById('resumen-cantidad');
        const resumenTotal = document.getElementById('resumen-total');
        const realizarDispensaBtn = document.getElementById('realizar-dispensa-btn');

        let sociosMap = new Map();
        let articulosMap = new Map();

        function listenToSociosForTPV() {
            const sociosCollectionRef = getSociosCollectionRef();
            if (!sociosCollectionRef) return;

            const q = query(sociosCollectionRef, orderBy("apellido", "asc"));
            onSnapshot(q, (snapshot) => {
                sociosMap.clear();
                tpvSociosDatalist.innerHTML = '';
                snapshot.forEach(doc => {
                    const socio = doc.data();
                    const nombreCompleto = `${socio.nombre} ${socio.apellido}`;
                    sociosMap.set(nombreCompleto, doc.id);
                    const option = document.createElement('option');
                    option.value = nombreCompleto;
                    tpvSociosDatalist.appendChild(option);
                });
            });
        }

        function listenToArticlesForTPV() {
            const q = query(collection(db, "articulos"), orderBy("nombre"));
            onSnapshot(q, (snapshot) => {
                articulosMap.clear();
                tpvArticulosDatalist.innerHTML = '';
                snapshot.forEach(doc => {
                    const article = doc.data();
                    articulosMap.set(article.nombre, { id: doc.id, precio: article.precioPorUnidad || 0 });
                    const option = document.createElement('option');
                    option.value = article.nombre;
                    tpvArticulosDatalist.appendChild(option);
                });
            });
        }

        function actualizarResumenTPV() {
            const socioNombre = tpvSocioInput.value;
            const articuloNombre = tpvArticuloInput.value;
            const cantidad = parseFloat(tpvCantidadInput.value);

            const socioId = sociosMap.get(socioNombre);
            const articuloData = articulosMap.get(articuloNombre);

            const isSocioValid = socioId;
            const isArticuloValid = articuloData;
            const isCantidadValid = !isNaN(cantidad) && cantidad > 0;

            resumenSocio.textContent = isSocioValid ? socioNombre : '--';
            resumenArticulo.textContent = isArticuloValid ? articuloNombre : '--';
            resumenCantidad.textContent = isCantidadValid ? cantidad : '--';

            const allValid = isSocioValid && isArticuloValid && isCantidadValid;

            if (allValid) {
                const total = cantidad * articuloData.precio;
                resumenTotal.textContent = `${total.toFixed(2)} €`;
                realizarDispensaBtn.disabled = false;
            } else {
                resumenTotal.textContent = '0.00 €';
                realizarDispensaBtn.disabled = true;
            }
        }

        tpvSocioInput.addEventListener('input', actualizarResumenTPV);
        tpvArticuloInput.addEventListener('input', actualizarResumenTPV);
        tpvCantidadInput.addEventListener('input', actualizarResumenTPV);

        async function procesarDispensa() {
            const socioNombre = tpvSocioInput.value;
            const articuloNombre = tpvArticuloInput.value;
            const cantidadDispensada = parseFloat(tpvCantidadInput.value);

            const idSocioSeleccionado = sociosMap.get(socioNombre);
            const articuloData = articulosMap.get(articuloNombre);
            const idArticuloSeleccionado = articuloData.id;
            const precioUnitario = articuloData.precio;
            const aporteTotalCalculado = cantidadDispensada * precioUnitario;

            realizarDispensaBtn.disabled = true;
            realizarDispensaBtn.textContent = "Procesando...";

            try {
                await runTransaction(db, async (transaction) => {
                    const articuloRef = doc(db, "articulos", idArticuloSeleccionado);
                    const sociosCollectionRef = getSociosCollectionRef();
                    if (!sociosCollectionRef) {
                        throw new Error("No se pudo obtener la referencia a la colección de socios.");
                    }
                    const socioRef = doc(sociosCollectionRef, idSocioSeleccionado);

                    // 1. Leer el stock y el socio DENTRO de la transacción
                    const articuloDoc = await transaction.get(articuloRef);
                    const socioDoc = await transaction.get(socioRef);

                    if (!articuloDoc.exists()) {
                        throw "El artículo ya no existe.";
                    }
                    if (!socioDoc.exists()) {
                        throw "El socio ya no existe.";
                    }

                    const stockActual = articuloDoc.data().stock;

                    // 2. Validar el stock
                    if (stockActual < cantidadDispensada) {
                        throw "Stock insuficiente para realizar la dispensa.";
                    }

                    // 3. Si hay stock, realizar las operaciones de escritura
                    const nuevoStock = stockActual - cantidadDispensada;
                    transaction.update(articuloRef, { stock: nuevoStock });

                    // 4. Crear el registro en la colección 'dispensas'
                    const dispensaRef = doc(collection(db, "dispensas")); // Crea una referencia para un nuevo doc
                    transaction.set(dispensaRef, {
                        idSocio: idSocioSeleccionado,
                        idArticulo: idArticuloSeleccionado,
                        nombreArticulo: articuloNombre,
                        nombreSocio: socioNombre,
                        cantidad: cantidadDispensada,
                        precioTotal: aporteTotalCalculado,
                        fecha: serverTimestamp()
                    });

                    // 5. Crear el registro en la colección 'historial'
                    const historialRef = doc(collection(db, "historial"));
                    transaction.set(historialRef, {
                        tipo: 'dispensa',
                        descripcion: `Dispensa de ${cantidadDispensada} uds. de "${articuloNombre}" a "${socioNombre}"`,
                        fecha: serverTimestamp()
                    });
                });

                showToast("¡Dispensa realizada con éxito!");
                // Resetear formulario TPV
                tpvSocioInput.value = '';
                tpvArticuloInput.value = '';
                tpvCantidadInput.value = '';
                actualizarResumenTPV();

            } catch (error) {
                console.error("Error en la transacción: ", error);
                showToast(typeof error === 'string' ? error : "Error al procesar la dispensa.", true);
            } finally {
                realizarDispensaBtn.disabled = false;
                realizarDispensaBtn.textContent = "REALIZAR DISPENSA";
                actualizarResumenTPV(); // Re-evalúa el estado del botón
            }
        }

        realizarDispensaBtn.addEventListener('click', procesarDispensa);


        // --- MÓDULO DE HISTORIAL ---
        const historialContainer = document.getElementById('historial-container');

        /**
         * Formatea un objeto Timestamp de Firestore a un string legible.
         * Ejemplo: "16 de Octubre de 2025, 14:30"
         * @param {object} timestamp - El objeto Timestamp de Firestore.
         * @returns {string} La fecha formateada o un texto alternativo.
         */
        function formatFirebaseTimestamp(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') {
                return 'Fecha no disponible';
            }
            const date = timestamp.toDate();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('es-ES', options);
        }

        function listenToHistory() {
            const q = query(collection(db, "historial"), orderBy("fecha", "desc"));

            onSnapshot(q, (snapshot) => {
                historialContainer.innerHTML = ''; // Limpiar el contenedor antes de renderizar
                if (snapshot.empty) {
                    historialContainer.innerHTML = '<p class="text-center text-slate-500">Aún no hay operaciones registradas.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const evento = doc.data();
                    const formattedDate = formatFirebaseTimestamp(evento.fecha);

                    // Determinar el estilo y el icono según el tipo de evento
                    const isDispensa = evento.tipo === 'dispensa';
                    const borderColorClass = isDispensa ? 'border-blue-500' : 'border-green-500';
                    const icon = isDispensa ? '🛒' : '📦';

                    // Crear el elemento del historial
                    const eventoElement = document.createElement('div');
                    eventoElement.className = `bg-slate-800 p-4 rounded-lg flex items-start gap-4 ${borderColorClass} border-l-4`;

                    eventoElement.innerHTML = `
                        <div class="text-2xl mt-1">${icon}</div>
                        <div class="flex-grow">
                            <p class="text-white">${evento.descripcion}</p>
                            <p class="text-sm text-slate-400 mt-1">${formattedDate}</p>
                        </div>
                    `;

                    historialContainer.appendChild(eventoElement);
                });
            });
        }

        // --- MÓDULO DE ESTADÍSTICAS (GRÁFICOS) ---
        let dispensasChartInstance = null;
        async function renderizarGraficoDispensas() {
            const ctx = document.getElementById('grafico-ventas-semanal').getContext('2d');

            // 1. Destruir instancia de gráfico anterior si existe
            if (dispensasChartInstance) {
                dispensasChartInstance.destroy();
            }

            try {
                // 2. Calcular el rango de fechas (últimos 7 días)
                const hoy = new Date();
                const fechaHace7Dias = new Date();
                fechaHace7Dias.setDate(hoy.getDate() - 7);
                fechaHace7Dias.setHours(0, 0, 0, 0); // Empezar desde el inicio del día

                // 3. Consultar TODAS las dispensas y filtrar en el cliente para evitar problemas de índices
                const dispensasRef = collection(db, "dispensas");
                const q = query(dispensasRef); // Sin filtro 'where'
                const querySnapshot = await getDocs(q);

                // 4. Procesar y agregar datos por día
                const dispensasPorDia = {}; // { 'YYYY-MM-DD': total, ... }
                querySnapshot.forEach(doc => {
                    const dispensa = doc.data();
                    if (dispensa.fecha && dispensa.fecha.toDate) {
                        const fechaDispensa = dispensa.fecha.toDate();

                        // Filtrado en el lado del cliente
                        if (fechaDispensa >= fechaHace7Dias) {
                            // Formato YYYY-MM-DD para usar como clave
                            const diaKey = fechaDispensa.toISOString().split('T')[0];

                            if (!dispensasPorDia[diaKey]) {
                                dispensasPorDia[diaKey] = 0;
                            }
                            dispensasPorDia[diaKey] += dispensa.precioTotal;
                        }
                    }
                });

                // 5. Preparar labels y data para el gráfico
                const labels = [];
                const data = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    d.setHours(0,0,0,0);
                    const diaKey = d.toISOString().split('T')[0];
                    // Formatear la label para mostrar en el gráfico (ej: Oct 16)
                    const labelFormatted = d.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });

                    labels.push(labelFormatted);
                    data.push(dispensasPorDia[diaKey] || 0);
                }

                // 6. Renderizar el nuevo gráfico
                dispensasChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Dispensado (€)',
                            data: data,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9CA3AF' // Color de los ticks del eje Y (slate claro)
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)' // Color de las líneas de la cuadrícula
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#9CA3AF' // Color de los ticks del eje X
                                },
                                 grid: {
                                    color: 'rgba(255, 255, 255, 0.1)' // Color de las líneas de la cuadrícula
                                }
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#E5E7EB' // Color del texto de la leyenda
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Error renderizando el gráfico de dispensas:", error);
                // Opcional: Mostrar un mensaje de error en el canvas
                ctx.font = "16px Arial";
                ctx.fillStyle = "red";
                ctx.textAlign = "center";
                ctx.fillText("No se pudieron cargar los datos del gráfico.", ctx.canvas.width / 2, 50);
            }
        }
        
    </script>
</body>
</html>